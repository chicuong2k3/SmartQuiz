@using SmartQuiz.Client.Components.Notifications
@inject NavigationManager NavigationManager
@inject ClientAuthHelper ClientAuthHelper
@inject Session Session
@inject INotificationService NotificationService
@inject ICommander Commander

<MudAppBar Elevation="0"
           Style="background-color: #0a092d; border-bottom: 1px solid #334155; height: 64px;">
    <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="d-flex align-center justify-space-between pa-0">
        <div class="d-flex align-center gap-4 grow">
            <!-- Mobile Menu Toggle -->
            <MudHidden Breakpoint="Breakpoint.MdAndUp">
                <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start"
                               OnClick="@ToggleDrawer" Class="mr-2"/>
            </MudHidden>

            <!-- Logo -->
            <div class="d-flex align-center gap-2 cursor-pointer shrink-0"
                 @onclick="@(() => NavigationManager.NavigateTo("/"))">
                <MudIcon Icon="@Icons.Material.Filled.School" Style="color: #4255FF;" Size="Size.Large"/>
                <MudHidden Breakpoint="Breakpoint.Xs">
                    <MudText Typo="Typo.h6" Class="fw-bold app-logo" Style="color: #4255FF;">QuizMaster</MudText>
                </MudHidden>
            </div>

            <!-- Navigation Links (Desktop) -->
            <MudHidden Breakpoint="Breakpoint.SmAndDown">
                <div class="d-flex align-center gap-1">
                    <MudButton Variant="Variant.Text" OnClick="@(() => NavigationManager.NavigateTo("/"))"
                               Class="header-nav-btn">Home
                    </MudButton>
                    <MudButton Variant="Variant.Text" OnClick="@(() => NavigationManager.NavigateTo("/my-quizzes"))"
                               Class="header-nav-btn">My Quizzes
                    </MudButton>
                    <MudButton Variant="Variant.Text" OnClick="@(() => NavigationManager.NavigateTo("/browse"))"
                               Class="header-nav-btn">Browse
                    </MudButton>
                    <MudButton Variant="Variant.Text" OnClick="@(() => NavigationManager.NavigateTo("/create"))"
                               Class="header-nav-btn">Create
                    </MudButton>
                    <MudButton Variant="Variant.Text" OnClick="@(() => NavigationManager.NavigateTo("/quiz-demo"))"
                               Class="header-nav-btn">Quiz Demo
                    </MudButton>
                </div>
            </MudHidden>

            <!-- Search Bar -->
            <MudTextField @bind-Value="_searchQuery"
                          Placeholder="Search..."
                          Variant="Variant.Outlined"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          Margin="Margin.Dense"
                          Class="search-field grow mx-4"/>
        </div>

        <div class="d-flex align-center gap-2">
            <AuthorizeView>
                <Authorized>
                    <!-- Notification Bell -->
                    <MudHidden Breakpoint="Breakpoint.Xs">
                        <MudMenu AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight"
                                 ActivationEvent="@MouseEvent.LeftClick">
                            <ActivatorContent>
                                <MudBadge Dot="@(UnreadCount > 0)" Color="Color.Error" Overlap="true">
                                    <MudIconButton Icon="@Icons.Material.Filled.Notifications" Class="header-icon-btn"
                                                   Size="Size.Medium"/>
                                </MudBadge>
                            </ActivatorContent>
                            <ChildContent>
                                <NotificationsPopover Items="Notifications" IsBusy="_notificationsBusy"
                                                      OnMarkAllRead="MarkAllRead" OnNotificationClick="MarkRead"/>
                            </ChildContent>
                        </MudMenu>
                    </MudHidden>

                    <!-- Help Icon -->
                    <MudHidden Breakpoint="Breakpoint.Xs">
                        <MudIconButton Icon="@Icons.Material.Filled.Help" Class="header-icon-btn" Size="Size.Medium"/>
                    </MudHidden>

                    <!-- User Dropdown Menu -->
                    <MudMenu AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight"
                             ActivationEvent="@MouseEvent.LeftClick">
                        <ActivatorContent>
                            <div class="d-flex align-center gap-2 cursor-pointer pa-2 user-avatar"
                                 style="border-radius: 8px;">
                                <MudHidden Breakpoint="Breakpoint.SmAndDown">
                                    <MudText Typo="Typo.body1" Style="color: #282E3E; font-weight: 600;">Alex Johnson
                                    </MudText>
                                </MudHidden>
                                <MudAvatar Size="Size.Medium"
                                           Style="background: linear-gradient(135deg, #4255FF 0%, #6B7FFF 100%);">
                                    <MudText Typo="Typo.body1" Class="text-white fw-bold">AJ</MudText>
                                </MudAvatar>
                                <MudIcon Icon="@Icons.Material.Filled.KeyboardArrowDown" Style="color: #586380;"
                                         Size="Size.Small"/>
                            </div>
                        </ActivatorContent>
                        <ChildContent>
                            <!-- User Info Header -->
                            <div class="pa-4" style="min-width: 280px;">
                                <div class="d-flex align-center gap-3 mb-3">
                                    <MudAvatar Size="Size.Large"
                                               Style="background: linear-gradient(135deg, #4255FF 0%, #6B7FFF 100%);">
                                        <MudText Typo="Typo.h6" Class="text-white fw-bold">AJ</MudText>
                                    </MudAvatar>
                                    <div>
                                        <MudText Typo="Typo.body1" Class="fw-bold">Alex Johnson</MudText>
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">alex.j@quizmaster.com
                                        </MudText>
                                        <MudChip T="string" Size="Size.Small" Color="Color.Primary"
                                                 Style="margin-top: 4px; height: 20px; font-size: 10px;">
                                            LEVEL 5 QUIZZER
                                        </MudChip>
                                    </div>
                                </div>
                            </div>

                            <MudDivider/>

                            <!-- Menu Items -->
                            <MudMenuItem OnClick="@(() => NavigationManager.NavigateTo("/profile"))">
                                <div class="d-flex align-center gap-3">
                                    <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small"/>
                                    <MudText Typo="Typo.body2">My Profile</MudText>
                                </div>
                            </MudMenuItem>

                            <MudMenuItem OnClick="@(() => NavigationManager.NavigateTo("/quiz-history"))">
                                <div class="d-flex align-center gap-3 position-relative">
                                    <MudIcon Icon="@Icons.Material.Filled.History" Size="Size.Small"/>
                                    <MudText Typo="Typo.body2">Quiz History</MudText>
                                    <MudIcon Icon="@Icons.Material.Filled.Circle" Size="Size.Small" Color="Color.Info"
                                             Style="position: absolute; right: 8px; font-size: 8px;"/>
                                </div>
                            </MudMenuItem>

                            <MudMenuItem OnClick="@(() => NavigationManager.NavigateTo("/settings"))">
                                <div class="d-flex align-center gap-3">
                                    <MudIcon Icon="@Icons.Material.Filled.Settings" Size="Size.Small"/>
                                    <MudText Typo="Typo.body2">Settings</MudText>
                                </div>
                            </MudMenuItem>

                            <MudMenuItem OnClick="@(() => NavigationManager.NavigateTo("/help"))">
                                <div class="d-flex align-center gap-3">
                                    <MudIcon Icon="@Icons.Material.Filled.Help" Size="Size.Small"/>
                                    <MudText Typo="Typo.body2">Help & Support</MudText>
                                </div>
                            </MudMenuItem>

                            <MudDivider Class="my-2"/>

                            <MudMenuItem OnClick="@Logout">
                                <div class="d-flex align-center gap-3">
                                    <MudIcon Icon="@Icons.Material.Filled.Logout" Size="Size.Small"
                                             Color="Color.Error"/>
                                    <MudText Typo="Typo.body2" Color="Color.Error">Log Out</MudText>
                                </div>
                            </MudMenuItem>

                            <!-- Version Footer -->
                            <MudDivider/>
                            <div class="pa-3 text-center">
                                <MudText Typo="Typo.caption" Color="Color.Secondary">v2.4.0</MudText>
                                <div class="d-flex justify-center gap-2 mt-2">
                                    <MudLink Typo="Typo.caption" Color="Color.Secondary">Terms</MudLink>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">â€¢</MudText>
                                    <MudLink Typo="Typo.caption" Color="Color.Secondary">Privacy</MudLink>
                                </div>
                            </div>
                        </ChildContent>
                    </MudMenu>
                </Authorized>
                <NotAuthorized>
                    <MudButton Variant="Variant.Text" OnClick="@(() => NavigationManager.NavigateTo("/login"))"
                               Class="header-nav-btn">Log in
                    </MudButton>
                    <MudButton Variant="Variant.Filled" OnClick="@(() => NavigationManager.NavigateTo("/signup"))"
                               Class="create-btn ml-2">Sign up
                    </MudButton>
                </NotAuthorized>
            </AuthorizeView>
        </div>
    </MudContainer>
</MudAppBar>

<!-- Mobile Navigation Drawer -->
<MudDrawer @bind-Open="@_drawerOpen" Anchor="Anchor.Left" Elevation="1" Variant="DrawerVariant.Temporary" Width="280px">
    <MudDrawerHeader Class="d-flex align-center gap-2 px-4 py-4">
        <MudIcon Icon="@Icons.Material.Filled.School" Style="color: #4255FF;" Size="Size.Large"/>
        <MudText Typo="Typo.h6" Class="fw-bold" Style="color: #4255FF;">QuizMaster</MudText>
        <MudSpacer/>
        <MudIconButton Icon="@Icons.Material.Filled.Close" OnClick="@ToggleDrawer" Color="Color.Default"
                       Size="Size.Small"/>
    </MudDrawerHeader>
    <MudNavMenu Class="pt-2">
        <MudNavLink OnClick="@(() =>
                             {
                                 NavigationManager.NavigateTo("/");
                                 ToggleDrawer();
                             })" Icon="@Icons.Material.Filled.Home">Home
        </MudNavLink>
        <MudNavLink OnClick="@(() =>
                             {
                                 NavigationManager.NavigateTo("/my-quizzes");
                                 ToggleDrawer();
                             })" Icon="@Icons.Material.Filled.LibraryBooks">My Quizzes
        </MudNavLink>
        <MudNavLink OnClick="@(() =>
                             {
                                 NavigationManager.NavigateTo("/browse");
                                 ToggleDrawer();
                             })" Icon="@Icons.Material.Filled.Search">Browse
        </MudNavLink>
        <MudNavLink OnClick="@(() =>
                             {
                                 NavigationManager.NavigateTo("/create");
                                 ToggleDrawer();
                             })" Icon="@Icons.Material.Filled.AddBox">Create
        </MudNavLink>
        <MudNavLink OnClick="@(() =>
                             {
                                 NavigationManager.NavigateTo("/quiz-demo");
                                 ToggleDrawer();
                             })" Icon="@Icons.Material.Filled.PlayCircle">Quiz Demo
        </MudNavLink>
    </MudNavMenu>
    <MudSpacer/>
    <AuthorizeView>
        <Authorized>
            <div class="px-4 py-4 border-t">
                <MudButton Variant="Variant.Text" FullWidth OnClick="@Logout" StartIcon="@Icons.Material.Filled.Logout"
                           Color="Color.Error">Log Out
                </MudButton>
            </div>
        </Authorized>
    </AuthorizeView>
</MudDrawer>

@code {
    private string _searchQuery = "";
    private bool _drawerOpen;

    private IReadOnlyList<NotificationDto> Notifications { get; set; } = Array.Empty<NotificationDto>();
    private bool _notificationsBusy;

    private int UnreadCount => Notifications.Count(x => !x.IsRead);

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await RefreshNotifications();
    }

    private async Task RefreshNotifications()
    {
        try
        {
            _notificationsBusy = true;
            Notifications = await NotificationService.GetMyNotificationsAsync(Session);
        }
        finally
        {
            _notificationsBusy = false;
        }
    }

    private async Task MarkAllRead()
    {
        try
        {
            _notificationsBusy = true;
            await Commander.Call(new MarkAllNotificationsReadCommand(Session));
        }
        finally
        {
            _notificationsBusy = false;
        }

        await RefreshNotifications();
    }

    private async Task MarkRead(NotificationDto item)
    {
        if (item.IsRead)
            return;

        try
        {
            _notificationsBusy = true;
            await Commander.Call(new MarkNotificationReadCommand(Session, item.Id));
        }
        finally
        {
            _notificationsBusy = false;
        }

        await RefreshNotifications();
    }

    private async Task Logout()
    {
        await ClientAuthHelper.SignOut(Session);
        NavigationManager.NavigateTo("/login");
    }

    private void ToggleDrawer() => _drawerOpen = !_drawerOpen;
}
