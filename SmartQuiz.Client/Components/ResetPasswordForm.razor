@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<div
    style="min-height: 100vh; background-color: #F5F5F5; display: flex; align-items: center; justify-content: center; padding: 24px;">
    <MudPaper Elevation="0"
              Style="max-width: 480px; width: 100%; padding: 48px 40px; border-radius: 12px; background: white;">
        <!-- Title Section -->
        <MudText Typo="Typo.h4" Style="font-weight: 700; color: #212121; margin-bottom: 8px;">
            Reset Password
        </MudText>

        <MudText Typo="Typo.body2" Style="color: #757575; margin-bottom: 32px; line-height: 1.5;">
            Enter a strong password to secure your quiz account.
        </MudText>

        <!-- New Password Field -->
        <div style="margin-bottom: 24px;">
            <MudText Typo="Typo.body2" Style="color: #212121; font-weight: 600; margin-bottom: 8px;">
                New Password
            </MudText>
            <MudTextField
                @bind-Value="_newPassword"
                Placeholder="Enter new password"
                Variant="Variant.Outlined"
                InputType="@NewPasswordInputType"
                Adornment="Adornment.End"
                AdornmentIcon="@(_showNewPassword ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
                OnAdornmentClick="@(() => _showNewPassword = !_showNewPassword)"
                Immediate="true"
                Style="margin: 0;"
                Class="password-field"
                @oninput="@(e => OnPasswordChange(e.Value?.ToString() ?? string.Empty))"/>
        </div>

        <!-- Confirm Password Field -->
        <div style="margin-bottom: 24px;">
            <MudText Typo="Typo.body2" Style="color: #212121; font-weight: 600; margin-bottom: 8px;">
                Confirm New Password
            </MudText>
            <MudTextField
                @bind-Value="_confirmPassword"
                Placeholder="Confirm new password"
                Variant="Variant.Outlined"
                InputType="@ConfirmPasswordInputType"
                Adornment="Adornment.End"
                AdornmentIcon="@(_showConfirmPassword ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
                OnAdornmentClick="@(() => _showConfirmPassword = !_showConfirmPassword)"
                Style="margin: 0;"
                Class="password-field"/>
        </div>

        <!-- Password Strength Section -->
        <div style="margin-bottom: 24px;">
            <div class="d-flex justify-space-between align-center" style="margin-bottom: 8px;">
                <MudText Typo="Typo.body2" Style="color: #212121; font-weight: 600;">
                    Password Strength
                </MudText>
                <MudText Typo="Typo.body2"
                         Style="@($"color: {GetStrengthColor()}; font-weight: 600; font-size: 13px;")">
                    @_strengthText
                </MudText>
            </div>

            <!-- Strength Progress Bar -->
            <div
                style="width: 100%; height: 6px; background-color: #E0E0E0; border-radius: 3px; overflow: hidden; margin-bottom: 20px;">
                <div
                    style="@($"height: 100%; background-color: {GetStrengthColor()}; width: {_strengthPercentage}%; transition: all 0.3s ease;")"></div>
            </div>

            <!-- Password Requirements -->
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <!-- At least 8 characters -->
                <div class="d-flex align-center gap-2">
                    @if (_hasMinLength)
                    {
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small"
                                 Style="color: #2196F3; font-size: 20px;"/>
                    }
                    else
                    {
                        <div
                            style="width: 20px; height: 20px; border-radius: 50%; border: 2px solid #BDBDBD; background: transparent;"></div>
                    }
                    <MudText Typo="Typo.body2"
                             Style="@($"color: {(_hasMinLength ? "#212121" : "#757575")}; font-size: 14px;")">
                        At least 8 characters
                    </MudText>
                </div>

                <!-- Contains a number -->
                <div class="d-flex align-center gap-2">
                    @if (_hasNumber)
                    {
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small"
                                 Style="color: #2196F3; font-size: 20px;"/>
                    }
                    else
                    {
                        <div
                            style="width: 20px; height: 20px; border-radius: 50%; border: 2px solid #BDBDBD; background: transparent;"></div>
                    }
                    <MudText Typo="Typo.body2"
                             Style="@($"color: {(_hasNumber ? "#212121" : "#757575")}; font-size: 14px;")">
                        Contains a number
                    </MudText>
                </div>

                <!-- Contains a special character -->
                <div class="d-flex align-center gap-2">
                    @if (_hasSpecialChar)
                    {
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small"
                                 Style="color: #2196F3; font-size: 20px;"/>
                    }
                    else
                    {
                        <div
                            style="width: 20px; height: 20px; border-radius: 50%; border: 2px solid #BDBDBD; background: transparent;"></div>
                    }
                    <MudText Typo="Typo.body2"
                             Style="@($"color: {(_hasSpecialChar ? "#212121" : "#757575")}; font-size: 14px;")">
                        Contains a special character
                    </MudText>
                </div>
            </div>
        </div>

        <!-- Update Password Button -->
        <MudButton
            Variant="Variant.Filled"
            Color="Color.Primary"
            FullWidth
            Size="Size.Large"
            Style="border-radius: 8px; text-transform: none; font-weight: 600; padding: 14px; background-color: #2196F3; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);"
            OnClick="@HandleUpdatePassword"
            Disabled="@(!IsFormValid() || _isUpdating)">
            @(_isUpdating ? "Updating..." : "Update Password")
        </MudButton>

        <!-- Back to Login Link -->
        <div class="d-flex justify-center align-center gap-1">
            <MudIcon Icon="@Icons.Material.Filled.ArrowBack" Size="Size.Small"
                     Style="color: #757575; font-size: 18px;"/>
            <MudButton
                Variant="Variant.Text"
                Style="text-transform: none; color: #757575; font-size: 14px; font-weight: 500; padding: 4px 8px;"
                OnClick="@HandleBackToLogin">
                Back to Login
            </MudButton>
        </div>
    </MudPaper>
</div>

@code {
    [Parameter] public string? Token { get; set; }
    [Parameter] public string? Email { get; set; }

    private string _newPassword = string.Empty;
    private string _confirmPassword = string.Empty;
    private bool _showNewPassword;
    private bool _showConfirmPassword;
    private bool _isUpdating;

    // Password validation states
    private bool _hasMinLength;
    private bool _hasNumber;
    private bool _hasSpecialChar;
    private string _strengthText = "Weak";
    private int _strengthPercentage;

    private InputType NewPasswordInputType => _showNewPassword ? InputType.Text : InputType.Password;
    private InputType ConfirmPasswordInputType => _showConfirmPassword ? InputType.Text : InputType.Password;

    private void OnPasswordChange(string password)
    {
        _newPassword = password;
        ValidatePassword(password);
    }

    private void ValidatePassword(string password)
    {
        _hasMinLength = password.Length >= 8;
        _hasNumber = password.Any(char.IsDigit);
        _hasSpecialChar = password.Any(ch => !char.IsLetterOrDigit(ch));

        // Calculate strength
        int strength = 0;
        if (_hasMinLength) strength++;
        if (_hasNumber) strength++;
        if (_hasSpecialChar) strength++;

        switch (strength)
        {
            case 0:
                _strengthText = "Weak";
                _strengthPercentage = 0;
                break;
            case 1:
                _strengthText = "Weak";
                _strengthPercentage = 33;
                break;
            case 2:
                _strengthText = "Medium";
                _strengthPercentage = 66;
                break;
            case 3:
                _strengthText = "Strong";
                _strengthPercentage = 100;
                break;
        }
    }

    private string GetStrengthColor()
    {
        return _strengthText switch
        {
            "Weak" => "#F44336",
            "Medium" => "#2196F3",
            "Strong" => "#4CAF50",
            _ => "#E0E0E0"
        };
    }

    private bool IsFormValid()
    {
        return _hasMinLength &&
               _hasNumber &&
               _hasSpecialChar &&
               !string.IsNullOrWhiteSpace(_confirmPassword) &&
               _newPassword == _confirmPassword;
    }

    private async Task HandleUpdatePassword()
    {
        if (!IsFormValid())
        {
            Snackbar.Add("Please meet all password requirements", Severity.Warning);
            return;
        }

        _isUpdating = true;
        StateHasChanged();

        try
        {
            // TODO: Implement actual password reset API call
            await Task.Delay(1500);

            Snackbar.Add("Password updated successfully!", Severity.Success);

            // Redirect to login page
            await Task.Delay(1000);
            Navigation.NavigateTo("/login");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isUpdating = false;
            StateHasChanged();
        }
    }

    private void HandleBackToLogin()
    {
        Navigation.NavigateTo("/login");
    }

}

