@using System.Text.RegularExpressions
@inject ISnackbar Snackbar
@inject ICommander Commander

<MudDialog>
    <DialogContent>
        <div style="padding: 24px 0;">
            @if (_resetSuccess)
            {
                <!-- Success State -->
                <div class="d-flex justify-center mb-4">
                    <div style="background: #E8F5E9; border-radius: 50%; padding: 16px; display: inline-flex;">
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Style="color: #4CAF50; font-size: 40px;"/>
                    </div>
                </div>

                <MudText Typo="Typo.h5"
                         Style="font-weight: 700; color: #212121; text-align: center; margin-bottom: 12px;">
                    Đặt lại mật khẩu thành công!
                </MudText>

                <MudText Typo="Typo.body2"
                         Style="color: #757575; text-align: center; margin-bottom: 24px; line-height: 1.6;">
                    Mật khẩu của bạn đã được cập nhật. Bạn có thể đăng nhập với mật khẩu mới.
                </MudText>

                <MudButton
                    Variant="Variant.Filled"
                    Color="Color.Primary"
                    FullWidth
                    OnClick="@HandleBackToLogin">
                    Quay lại đăng nhập
                </MudButton>
            }
            else if (_showNewPasswordForm)
            {
                <!-- New Password Form -->
                <div class="d-flex justify-center mb-4">
                    <div style="background: #E3F2FD; border-radius: 50%; padding: 16px; display: inline-flex;">
                        <MudIcon Icon="@Icons.Material.Filled.Lock" Style="color: #2196F3; font-size: 40px;"/>
                    </div>
                </div>

                <MudText Typo="Typo.h5"
                         Style="font-weight: 700; color: #212121; text-align: center; margin-bottom: 12px;">
                    Tạo mật khẩu mới
                </MudText>

                <MudText Typo="Typo.body2"
                         Style="color: #757575; text-align: center; margin-bottom: 24px; line-height: 1.6;">
                    Vui lòng nhập mật khẩu mới cho tài khoản của bạn.
                </MudText>

                @if (!string.IsNullOrEmpty(_errorMessage))
                {
                    <MudAlert Severity="Severity.Error" Class="mb-4" Dense="true" Elevation="0">
                        @_errorMessage
                    </MudAlert>
                }

                <MudForm @ref="@_passwordForm" @bind-IsValid="_isPasswordFormValid">
                    <MudTextField
                        @bind-Value="_newPassword"
                        Label="Mật khẩu mới"
                        Variant="Variant.Outlined"
                        Margin="Margin.Dense"
                        FullWidth
                        Class="mb-4"
                        InputType="@_passwordInputType"
                        Adornment="Adornment.End"
                        AdornmentIcon="@_passwordIcon"
                        OnAdornmentClick="TogglePasswordVisibility"
                        Validation="@(new Func<string, string?>(ValidatePassword))"/>

                    <MudTextField
                        @bind-Value="_confirmPassword"
                        Label="Xác nhận mật khẩu"
                        Variant="Variant.Outlined"
                        Margin="Margin.Dense"
                        FullWidth
                        Class="mb-4"
                        InputType="@_confirmPasswordInputType"
                        Adornment="Adornment.End"
                        AdornmentIcon="@_confirmPasswordIcon"
                        OnAdornmentClick="ToggleConfirmPasswordVisibility"
                        Validation="@(new Func<string, string?>(ValidateConfirmPassword))"/>

                    <MudButton
                        Variant="Variant.Filled"
                        Color="Color.Primary"
                        FullWidth
                        OnClick="@HandleResetPassword"
                        Disabled="@_isLoading">
                        @if (_isLoading)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Color="Color.Surface"/>
                        }
                        else
                        {
                            <text>Đặt lại mật khẩu</text>
                        }
                    </MudButton>
                </MudForm>
            }
            else if (_showOtpForm)
            {
                <!-- OTP Verification Form -->
                <div class="d-flex justify-center mb-4">
                    <div style="background: #E3F2FD; border-radius: 50%; padding: 16px; display: inline-flex;">
                        <MudIcon Icon="@Icons.Material.Filled.MarkEmailRead" Style="color: #2196F3; font-size: 40px;"/>
                    </div>
                </div>

                <MudText Typo="Typo.h5"
                         Style="font-weight: 700; color: #212121; text-align: center; margin-bottom: 12px;">
                    Nhập mã OTP
                </MudText>

                <MudText Typo="Typo.body2"
                         Style="color: #757575; text-align: center; margin-bottom: 8px; line-height: 1.6;">
                    Chúng tôi đã gửi mã OTP đến
                </MudText>

                <MudText Typo="Typo.body1"
                         Style="color: #212121; text-align: center; margin-bottom: 24px; font-weight: 600;">
                    @_email
                </MudText>

                @if (!string.IsNullOrEmpty(_errorMessage))
                {
                    <MudAlert Severity="Severity.Error" Class="mb-4" Dense="true" Elevation="0">
                        @_errorMessage
                    </MudAlert>
                }

                <MudForm @ref="@_otpForm" @bind-IsValid="_isOtpFormValid">
                    <div class="mb-4 otp-container">
                        <MudCodeInput T="string"
                                      @bind-Value="@_otpCode" Count="6" Spacing="1" Variant="Variant.Outlined"
                                      Margin="Margin.None"/>
                    </div>

                    <MudButton
                        Variant="Variant.Filled"
                        Color="Color.Primary"
                        FullWidth
                        Class="mb-4"
                        OnClick="@HandleVerifyOtp"
                        Disabled="@_isLoading">
                        @if (_isLoading)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Color="Color.Surface"/>
                        }
                        else
                        {
                            <text>Xác nhận</text>
                        }
                    </MudButton>
                </MudForm>

                <div class="text-center">
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-2">
                        Không nhận được mã?
                    </MudText>
                    <MudButton Variant="Variant.Text" Color="Color.Primary"
                               OnClick="@HandleResendOtp"
                               Disabled="@(_resendCooldown > 0)">
                        @if (_resendCooldown > 0)
                        {
                            <text>Gửi lại sau @_resendCooldown giây</text>
                        }
                        else
                        {
                            <text>Gửi lại mã OTP</text>
                        }
                    </MudButton>
                </div>

                <MudDivider Class="my-4"/>

                <div class="text-center">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        Mã OTP sẽ hết hạn sau 5 phút
                    </MudText>
                </div>
            }
            else
            {
                <!-- Email Input Form -->
                <div class="d-flex justify-center mb-4">
                    <div style="background: #E3F2FD; border-radius: 50%; padding: 16px; display: inline-flex;">
                        <MudIcon Icon="@Icons.Material.Filled.Autorenew" Style="color: #2196F3; font-size: 40px;"/>
                    </div>
                </div>

                <MudText Typo="Typo.h5"
                         Style="font-weight: 700; color: #212121; text-align: center; margin-bottom: 12px;">
                    Bạn quên mật khẩu?
                </MudText>

                <MudText Typo="Typo.body2"
                         Style="color: #757575; text-align: center; margin-bottom: 24px; line-height: 1.6;">
                    Vui lòng nhập địa chỉ email liên kết với tài khoản của bạn và chúng tôi sẽ gửi cho bạn OTP để đặt
                    lại mật khẩu.
                </MudText>

                @if (!string.IsNullOrEmpty(_errorMessage))
                {
                    <MudAlert Severity="Severity.Error" Class="mb-4" Dense="true" Elevation="0">
                        @_errorMessage
                    </MudAlert>
                }

                <MudTextField
                    @bind-Value="_email"
                    Label="Email"
                    Variant="Variant.Outlined"
                    Margin="Margin.Dense"
                    FullWidth
                    Class="mb-4"
                    Placeholder="name@example.com"
                    Adornment="Adornment.Start"
                    AdornmentIcon="@Icons.Material.Filled.Email"
                    AdornmentColor="Color.Default"/>

                <MudButton
                    Variant="Variant.Filled"
                    Color="Color.Primary"
                    FullWidth
                    OnClick="@HandleSendOtp"
                    Disabled="@_isLoading">
                    @if (_isLoading)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Color="Color.Surface"/>
                    }
                    else
                    {
                        <text>Gửi mã OTP</text>
                    }
                </MudButton>
            }
        </div>
    </DialogContent>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = null!;

    private string _email = string.Empty;
    private string _otpCode = string.Empty;
    private string _newPassword = string.Empty;
    private string _confirmPassword = string.Empty;
    private string _errorMessage = string.Empty;

    private bool _isLoading;
    private bool _showOtpForm;
    private bool _showNewPasswordForm;
    private bool _resetSuccess;

    private MudForm _otpForm = null!;
    private MudForm _passwordForm = null!;
    private bool _isOtpFormValid;
    private bool _isPasswordFormValid;

    private int _resendCooldown;
    private Timer? _resendTimer;

    private bool _passwordVisible;
    private InputType _passwordInputType = InputType.Password;
    private string _passwordIcon = Icons.Material.Filled.VisibilityOff;

    private bool _confirmPasswordVisible;
    private InputType _confirmPasswordInputType = InputType.Password;
    private string _confirmPasswordIcon = Icons.Material.Filled.VisibilityOff;

    private async Task HandleSendOtp()
    {
        if (string.IsNullOrWhiteSpace(_email))
        {
            _errorMessage = "Vui lòng nhập địa chỉ email";
            return;
        }

        if (!Regex.IsMatch(_email, @"^[^@\s]+@[^@\s]+\.[^@\s]+$"))
        {
            _errorMessage = "Email không hợp lệ";
            return;
        }

        _isLoading = true;
        _errorMessage = string.Empty;
        StateHasChanged();

        try
        {
            await Commander.Call(new SendPasswordResetOtpCommand(_email));
            _showOtpForm = true;
            StartResendCooldown();
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleVerifyOtp()
    {
        if (string.IsNullOrWhiteSpace(_otpCode) || _otpCode.Length != 6)
        {
            _errorMessage = "Vui lòng nhập đầy đủ mã OTP";
            return;
        }

        _isLoading = true;
        _errorMessage = string.Empty;
        StateHasChanged();

        try
        {
            var isValid = await Commander.Call(new VerifyPasswordResetOtpCommand(_email, _otpCode));

            if (isValid)
            {
                _showOtpForm = false;
                _showNewPasswordForm = true;
            }
            else
            {
                _errorMessage = "Mã OTP không đúng hoặc đã hết hạn";
                _otpCode = string.Empty;
            }
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleResetPassword()
    {
        await _passwordForm.Validate();
        if (!_isPasswordFormValid)
            return;

        _isLoading = true;
        _errorMessage = string.Empty;
        StateHasChanged();

        try
        {
            var result = await Commander.Call(new ResetPasswordCommand(_email, _otpCode, _newPassword));

            if (result)
            {
                _showNewPasswordForm = false;
                _resetSuccess = true;
            }
            else
            {
                _errorMessage = "Mã OTP không đúng hoặc đã hết hạn. Vui lòng thử lại.";
                _showNewPasswordForm = false;
                _showOtpForm = true;
                _otpCode = string.Empty;
            }
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleResendOtp()
    {
        if (_resendCooldown > 0)
            return;

        _isLoading = true;
        _errorMessage = string.Empty;
        StateHasChanged();

        try
        {
            await Commander.Call(new SendPasswordResetOtpCommand(_email));
            StartResendCooldown();
            Snackbar.Add("Mã OTP mới đã được gửi!", Severity.Success);
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private void StartResendCooldown()
    {
        _resendCooldown = 60;
        _resendTimer?.Dispose();
        _resendTimer = new Timer(_ =>
        {
            if (_resendCooldown > 0)
            {
                _resendCooldown--;
                InvokeAsync(StateHasChanged);
            }
            else
            {
                _resendTimer?.Dispose();
            }
        }, null, TimeSpan.Zero, TimeSpan.FromSeconds(1));
    }

    private void HandleBackToLogin()
    {
        MudDialog.Close(DialogResult.Ok(true));
    }

    private string? ValidatePassword(string password)
    {
        if (string.IsNullOrWhiteSpace(password))
            return "Mật khẩu không được để trống";
        if (password.Length < 6)
            return "Mật khẩu phải có ít nhất 6 ký tự";
        return null;
    }

    private string? ValidateConfirmPassword(string confirmPassword)
    {
        if (string.IsNullOrWhiteSpace(confirmPassword))
            return "Xác nhận mật khẩu không được để trống";
        if (confirmPassword != _newPassword)
            return "Mật khẩu xác nhận không khớp";
        return null;
    }

    private void TogglePasswordVisibility()
    {
        _passwordVisible = !_passwordVisible;
        _passwordInputType = _passwordVisible ? InputType.Text : InputType.Password;
        _passwordIcon = _passwordVisible ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff;
    }

    private void ToggleConfirmPasswordVisibility()
    {
        _confirmPasswordVisible = !_confirmPasswordVisible;
        _confirmPasswordInputType = _confirmPasswordVisible ? InputType.Text : InputType.Password;
        _confirmPasswordIcon = _confirmPasswordVisible ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff;
    }

    public void Dispose()
    {
        _resendTimer?.Dispose();
    }

}