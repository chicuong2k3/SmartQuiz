@page "/flashcard-sets/create"

@inject ICommander Commander
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject Session Session

<PageTitle>Tạo bộ thẻ flashcard mới</PageTitle>

<div class="min-h-screen bg-app-background py-8">
    <MudContainer MaxWidth="MaxWidth.Medium">
        <!-- Header -->
        <MudText Typo="Typo.h4" Class="fw-bold mb-1 text-primary-color">Tạo bộ thẻ flashcard mới</MudText>
        <MudText Typo="Typo.body2" Class="text-secondary-color mb-6">
            Tạo bộ thẻ flashcard để giúp bạn học tập hiệu quả hơn!
        </MudText>

        <MudForm @ref="_form" ValidationDelay="0" @bind-IsValid="_isFormValid">
            <!-- Title and Description -->
            <MudPaper Elevation="0" Class="pa-5 mb-6 rounded-lg bg-app-surface">
                <MudGrid Spacing="4">
                    <MudItem xs="12">
                        <MudText Typo="Typo.body2" Class="mb-2">Tên bộ thẻ</MudText>
                        <MudTextField
                            @bind-Value="_title"
                            Variant="Variant.Outlined"
                            Placeholder="Ví dụ: Từ vựng tiếng Anh cơ bản"
                            Required="true"
                            RequiredError="Vui lòng nhập tên bộ thẻ"
                            MaxLength="200"
                            Immediate="true"
                            Validation="@((string value) => ValidateTitle(value))"
                            Margin="Margin.Dense"
                            Class="mud-input-outlined-white"/>
                    </MudItem>
                    <MudItem xs="12">
                        <MudText Typo="Typo.body2" Class="mb-2">Mô tả</MudText>
                        <MudTextField
                            @bind-Value="_description"
                            Variant="Variant.Outlined"
                            Placeholder="Thêm mô tả..."
                            MaxLength="1000"
                            Immediate="true"
                            Margin="Margin.Dense" Lines="4"
                            Class="mud-input-outlined-white"/>
                    </MudItem>
                </MudGrid>

                <!-- Visibility Options -->
                <div class="mt-5">
                    <MudText Typo="Typo.body2" Class="mb-3">Ai có thể xem bộ thẻ này?</MudText>
                    <div class="d-flex gap-3 visibility-toggle">
                        <MudButton
                            Variant="@(Visibility == "everyone" ? Variant.Filled : Variant.Outlined)"
                            Color="@(Visibility == "everyone" ? Color.Primary : Color.Default)"
                            OnClick="@(() => Visibility = "everyone")"
                            StartIcon="@Icons.Material.Filled.Public"
                            Class="rounded-pill text-transform-none">
                            Mọi người
                        </MudButton>
                        <MudButton
                            Variant="@(Visibility == "justme" ? Variant.Filled : Variant.Outlined)"
                            Color="@(Visibility == "justme" ? Color.Primary : Color.Default)"
                            OnClick="@(() => Visibility = "justme")"
                            StartIcon="@Icons.Material.Filled.Lock"
                            Class="rounded-pill text-transform-none">
                            Chỉ mình tôi
                        </MudButton>
                    </div>
                </div>
            </MudPaper>

            <!-- Flashcards Section -->
            <div class="mb-4">
                <div class="d-flex justify-space-between align-center mb-4">
                    <MudText Typo="Typo.h6" Class="fw-bold text-primary-color">Flashcards</MudText>
                    <MudButton Variant="Variant.Text" Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.ImportExport"
                               Class="text-transform-none">
                        Nhập từ Excel
                    </MudButton>
                </div>

                @for (int i = 0; i < _flashcards.Count; i++)
                {
                    var index = i;
                    <MudPaper Elevation="0" Class="mb-4 rounded-lg overflow-hidden bg-app-surface border-twilight">
                        <!-- Card Header -->
                        <div class="d-flex justify-space-between align-center px-5 py-3 border-b border-twilight">
                            <MudText Typo="Typo.body1" Class="fw-semibold text-primary-color">@(index + 1)</MudText>
                            @if (_flashcards.Count > 1)
                            {
                                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                               Size="Size.Small"
                                               Color="Color.Default"
                                               OnClick="@(() => RemoveFlashcard(index))"
                                               tabindex="-1"/>
                            }
                        </div>

                        <!-- Card Content -->
                        <div class="pa-5">
                            <MudGrid Spacing="4">
                                <MudItem xs="12" md="6">
                                    <MudText Typo="Typo.caption"
                                             Class="fw-bold text-secondary-color mb-2 tracking-wide">Mặt trước
                                    </MudText>
                                    <MudTextField
                                        @bind-Value="_flashcards[index].Term"
                                        Variant="Variant.Outlined"
                                        Placeholder="Nhập mặt trước"
                                        Margin="Margin.Dense" Lines="4"
                                        Class="mud-input-outlined-white"/>
                                </MudItem>
                                <MudItem xs="12" md="6">
                                    <MudText Typo="Typo.caption"
                                             Class="fw-bold text-secondary-color mb-2 tracking-wide">Mặt sau
                                    </MudText>
                                    <MudTextField
                                        @bind-Value="_flashcards[index].Definition"
                                        Variant="Variant.Outlined"
                                        Placeholder="Nhập mặt sau"
                                        Margin="Margin.Dense" Lines="4"
                                        Class="mud-input-outlined-white"/>
                                </MudItem>
                            </MudGrid>
                        </div>
                    </MudPaper>
                }

                <!-- Add Card Button -->
                <div class="add-card-btn" @onclick="AddFlashcard">
                    <div class="d-flex flex-column align-center justify-center">
                        <div class="add-card-icon">
                            <MudIcon Icon="@Icons.Material.Outlined.Add"/>
                        </div>
                        <MudText Typo="Typo.body2" Class="text-secondary-color fw-semibold">Thêm thẻ</MudText>
                    </div>
                </div>
            </div>

            <!-- Create Set Button -->
            <div class="d-flex justify-end mt-6">
                <MudButton
                    OnClick="@HandleSubmit"
                    Variant="Variant.Filled"
                    Color="Color.Primary"
                    Size="Size.Large"
                    Disabled="@_isSubmitting"
                    Class="px-8 rounded-lg text-transform-none font-semibold">
                    @(_isSubmitting ? "Đang tạo..." : "Tạo bộ thẻ")
                </MudButton>
            </div>
        </MudForm>
    </MudContainer>
</div>

@code {
    private bool _isSubmitting;
    private MudForm? _form;
    private bool _isFormValid;

    // Form data (separate from command to avoid Session initialization issue)
    private string _title = string.Empty;
    private string? _description;
    private bool _isPublic = true;

    private readonly List<FlashcardItemCommand> _flashcards =
    [
        new FlashcardItemCommand()
    ];

    private string Visibility
    {
        get => _isPublic ? "everyone" : "justme";
        set => _isPublic = value == "everyone";
    }

    private void AddFlashcard()
    {
        _flashcards.Add(new FlashcardItemCommand());
    }

    private void RemoveFlashcard(int index)
    {
        if (_flashcards.Count > 1)
        {
            _flashcards.RemoveAt(index);
        }
    }

    private string? ValidateTitle(string value)
    {
        if (string.IsNullOrWhiteSpace(value))
            return "Vui lòng nhập tên bộ thẻ";

        if (value.Length < 3)
            return "Tên bộ thẻ phải có ít nhất 3 ký tự";

        if (value.Length > 200)
            return "Tên bộ thẻ không được vượt quá 200 ký tự";

        return null;
    }

    private async Task HandleSubmit()
    {
        if (_form == null)
            return;

        await _form.Validate();
        if (!_isFormValid)
            return;

        // Validate that at least one flashcard has content
        var validFlashcards = _flashcards
            .Where(f => !string.IsNullOrWhiteSpace(f.Term) || !string.IsNullOrWhiteSpace(f.Definition))
            .ToList();

        if (validFlashcards.Count == 0)
        {
            Snackbar.Add("Thêm ít nhất 1 thẻ", Severity.Warning);
            return;
        }

        try
        {
            _isSubmitting = true;

            var command = new CreateFlashcardSetCommand(
                Session,
                _title,
                _description,
                _isPublic,
                validFlashcards
            );
            var result = await Commander.Call(command);

            Snackbar.Add($"Bộ thẻ '{result.Title}' đã được tạo!", Severity.Success);
            Navigation.NavigateTo($"/flashcard-sets/{result.Id}");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Có lỗi xảy ra: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSubmitting = false;
            StateHasChanged();
        }
    }

}
