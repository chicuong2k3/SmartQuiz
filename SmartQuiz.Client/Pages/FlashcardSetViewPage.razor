@page "/flashcard-sets/{Id:guid}"
@inherits ComputedStateComponent<FlashcardSetViewState>

@inject IFlashcardSetService FlashcardSetService
@inject IFlashcardService FlashcardService
@inject NavigationManager NavigationManager

<PageTitle>@(_setTitle ?? "Flashcard Set")</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="py-6">
    @if (State.HasValue)
    {
        var state = State.Value;

        @if (state.FlashcardSet != null)
        {
            <!-- Breadcrumb Navigation -->
            <MudBreadcrumbs Items="_breadcrumbs" Class="px-0 mb-4"></MudBreadcrumbs>

            <!-- Header Section -->
            <div class="mb-6">
                <div class="d-flex justify-space-between align-center mb-3">
                    <div>
                        <MudText Typo="Typo.h4" Class="fw-bold mb-2">@state.FlashcardSet.Title</MudText>
                        <div class="d-flex align-center gap-3">
                            <MudAvatar Color="Color.Primary" Size="Size.Small">A</MudAvatar>
                            <MudText Typo="Typo.body1">AstroFan</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                â€¢ @state.FlashcardSet.FlashcardCount Terms
                            </MudText>
                            <MudRating ReadOnly="true" SelectedValue="4" Size="Size.Small"/>
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.Share">
                            Share
                        </MudButton>
                        <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.Edit"
                                   OnClick="@EditSet">
                            Edit
                        </MudButton>
                        <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.PlayArrow" Size="Size.Large">
                            Study Mode
                        </MudButton>
                    </div>
                </div>
            </div>

            <!-- Study Options Tabs -->
            <MudPaper Elevation="1" Class="mb-6" Style="border-radius: 12px; overflow: hidden;">
                <MudTabs Elevation="0" Rounded="true" Color="Color.Primary" Class="pa-2">
                    <MudTabPanel Text="TERM" Icon="@Icons.Material.Filled.ViewList">
                        <div class="pa-4">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">View and study all terms in this set
                            </MudText>
                        </div>
                    </MudTabPanel>
                    <MudTabPanel Text="Flip" Icon="@Icons.Material.Filled.Flip">
                        <div class="pa-4">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Flip through flashcards</MudText>
                        </div>
                    </MudTabPanel>
                    <MudTabPanel Text="Hangouts" Icon="@Icons.Material.Filled.Groups">
                        <div class="pa-4">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Study with friends</MudText>
                        </div>
                    </MudTabPanel>
                </MudTabs>

                <!-- Flashcard Display Area -->
                <div class="d-flex justify-center align-center pa-8"
                     Style="min-height: 300px; background-color: #f5f5f5;">
                    @if (_currentFlashcard != null)
                    {
                        <MudCard Style="width: 500px; height: 300px; cursor: pointer; border-radius: 16px;"
                                 Elevation="3" @onclick="FlipCard">
                            <MudCardContent Class="d-flex flex-column justify-center align-center"
                                            Style="height: 100%;">
                                <MudText Typo="Typo.h4" Align="Align.Center">
                                    @(_isFlipped ? _currentFlashcard.BackText : _currentFlashcard.FrontText)
                                </MudText>
                                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-4">
                                    Click to flip
                                </MudText>
                            </MudCardContent>
                        </MudCard>
                    }
                    else if (state.Flashcards.Count == 0)
                    {
                        <MudText Typo="Typo.h6" Color="Color.Secondary">
                            No flashcards in this set yet
                        </MudText>
                    }
                </div>

                <!-- Navigation Controls -->
                @if (state.Flashcards.Count > 0)
                {
                    <div class="d-flex justify-center align-center gap-4 pa-4">
                        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" OnClick="@PreviousCard"
                                       Disabled="@(_currentCardIndex == 0)"/>
                        <MudText Typo="Typo.body1">@(_currentCardIndex + 1) / @state.Flashcards.Count</MudText>
                        <MudIconButton Icon="@Icons.Material.Filled.ArrowForward" OnClick="@NextCard"
                                       Disabled="@(_currentCardIndex >= state.Flashcards.Count - 1)"/>
                    </div>
                }
            </MudPaper>

            <!-- Terms List Section -->
            <div class="mb-4">
                <div class="d-flex justify-space-between align-center mb-3">
                    <MudText Typo="Typo.h6" Class="fw-bold">Terms in this set (@state.Flashcards.Count)</MudText>
                    <MudSelect T="string" Value="@_sortOrder" ValueChanged="OnSortOrderChanged"
                               Variant="Variant.Outlined" Margin="Margin.Dense" Style="width: 200px;">
                        <MudSelectItem Value="@("original")">Original Order</MudSelectItem>
                        <MudSelectItem Value="@("alphabetical")">Alphabetical</MudSelectItem>
                    </MudSelect>
                </div>

                <MudPaper Elevation="1" Class="pa-4" Style="border-radius: 12px;">
                    @if (state.Flashcards.Any())
                    {
                        @foreach (var flashcard in GetSortedFlashcards(state.Flashcards))
                        {
                            <MudCard Elevation="0" Class="mb-3 hover-card"
                                     Style="border: 1px solid #e0e0e0; border-radius: 8px;">
                                <MudCardContent>
                                    <MudGrid>
                                        <MudItem xs="5">
                                            <MudText Typo="Typo.body1" Class="fw-bold">@flashcard.FrontText</MudText>
                                        </MudItem>
                                        <MudItem xs="7">
                                            <MudText Typo="Typo.body1"
                                                     Color="Color.Secondary">@flashcard.BackText</MudText>
                                        </MudItem>
                                    </MudGrid>
                                </MudCardContent>
                            </MudCard>
                        }

                        <MudButton Variant="Variant.Text" Color="Color.Primary" FullWidth="true" Class="mt-2">
                            See all @state.Flashcards.Count terms
                        </MudButton>
                    }
                    else
                    {
                        <MudText Typo="Typo.body1" Color="Color.Secondary" Align="Align.Center" Class="py-6">
                            No flashcards available. Click "Edit" to add some!
                        </MudText>
                    }
                </MudPaper>
            </div>

            <!-- Study Mode Options -->
            <MudPaper Elevation="1" Class="pa-6 mt-6"
                      Style="border-radius: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <MudText Typo="Typo.h6" Class="fw-bold mb-2" Style="color: white;">Ready to master this set?</MudText>
                <MudText Typo="Typo.body2" Class="mb-4" Style="color: rgba(255,255,255,0.9);">
                    Try the different study modes to test your knowledge.
                </MudText>
                <div class="d-flex gap-3">
                    <MudButton Variant="Variant.Filled" Color="Color.Surface" Size="Size.Large">
                        Test
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" Style="border-color: white; color: white;" Size="Size.Large">
                        Match
                    </MudButton>
                </div>
            </MudPaper>
        }
        else
        {
            <MudAlert Severity="Severity.Warning">Flashcard set not found.</MudAlert>
        }
    }
    else if (State.HasError)
    {
        <MudAlert Severity="Severity.Error">@(State.Error?.Message ?? "An error occurred")</MudAlert>
    }
    else
    {
        <div class="d-flex justify-center align-center" style="min-height: 400px;">
            <MudProgressCircular Indeterminate="true" Size="Size.Large"/>
        </div>
    }
</MudContainer>

<style>
    .hover-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .hover-card:hover {
        transform: translateX(4px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1) !important;
    }
</style>

@code {
    [Parameter] public Guid Id { get; set; }

    private string? _setTitle;
    private List<BreadcrumbItem> _breadcrumbs = new();
    private int _currentCardIndex;
    private bool _isFlipped;
    private FlashcardDto? _currentFlashcard;
    private string _sortOrder = "original";

    protected override async Task<FlashcardSetViewState> ComputeState(CancellationToken cancellationToken)
    {
        var set = await FlashcardSetService.GetFlashcardSetByIdAsync(Id, cancellationToken);
        var flashcards = (await FlashcardService.GetFlashcardsAsync(cancellationToken))
                .Where(f => f.StudySetId == Id)
                .ToImmutableList();

        if (set != null)
        {
            _setTitle = set.Title;
            UpdateBreadcrumbs(set);

            if (flashcards.Any() && _currentFlashcard == null)
            {
                _currentFlashcard = flashcards[0];
            }
        }

        return new FlashcardSetViewState
        {
                FlashcardSet = set,
                Flashcards = flashcards
        };
    }

    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();
        _currentCardIndex = 0;
        _isFlipped = false;
        _currentFlashcard = null;
    }

    private void UpdateBreadcrumbs(FlashcardSetDto set)
    {
        _breadcrumbs =
        [
                new BreadcrumbItem("Home", href: "/"),
                new BreadcrumbItem("Sciences", href: "/sciences"),
                new BreadcrumbItem("Astrophysics", href: "/astrophysics"),
                new BreadcrumbItem(set.Title, href: null, disabled: true)
        ];
    }

    private void FlipCard()
    {
        _isFlipped = !_isFlipped;
    }

    private void NextCard()
    {
        if (_currentCardIndex < State.Value.Flashcards.Count - 1)
        {
            _currentCardIndex++;
            _currentFlashcard = State.Value.Flashcards[_currentCardIndex];
            _isFlipped = false;
        }
    }

    private void PreviousCard()
    {
        if (_currentCardIndex > 0)
        {
            _currentCardIndex--;
            _currentFlashcard = State.Value.Flashcards[_currentCardIndex];
            _isFlipped = false;
        }
    }

    private void OnSortOrderChanged(string newOrder)
    {
        _sortOrder = newOrder;
        StateHasChanged();
    }

    private IEnumerable<FlashcardDto> GetSortedFlashcards(ImmutableList<FlashcardDto> flashcards)
    {
        return _sortOrder == "alphabetical"
                ? flashcards.OrderBy(f => f.FrontText)
                : flashcards;
    }

    private void EditSet()
    {
        NavigationManager.NavigateTo($"/flashcard-sets/{Id}/edit");
    }

}

