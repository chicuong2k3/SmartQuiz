@page "/flashcard-sets/{Id:guid}"
@inherits ComputedStateComponent<FlashcardSetViewState>

@inject IFlashcardSetService FlashcardSetService
@inject IFlashcardService FlashcardService
@inject NavigationManager NavigationManager

<PageTitle>@(_setTitle ?? "Flashcard Set")</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="py-6">
    @if (State.HasValue && State.Value != null)
    {
        var state = State.Value;

        @if (state.FlashcardSet != null)
        {
            <!-- Breadcrumb Navigation -->
            <MudBreadcrumbs Items="_breadcrumbs" Class="px-0 mb-4"></MudBreadcrumbs>

            <!-- Header Section with Title and Metadata -->
            <div class="mb-6">
                <MudText Typo="Typo.h4" Class="fw-bold mb-2">@state.FlashcardSet.Title</MudText>
                <div class="d-flex align-center gap-3 mb-4">
                    <MudAvatar Color="Color.Dark" Size="Size.Small">
                        <MudText Typo="Typo.body2" Class="text-white fw-bold">AF</MudText>
                    </MudAvatar>
                    <MudText Typo="Typo.body1">AstroFan</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">â€¢ @state.FlashcardSet.FlashcardCount Terms
                    </MudText>
                    <MudRating ReadOnly="true" SelectedValue="4" Size="Size.Small" Color="Color.Warning"/>
                </div>

                <div class="d-flex gap-2">
                    <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.Share" Size="Size.Small">
                        Share
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.Edit" Size="Size.Small"
                               OnClick="@EditSet">
                        Edit
                    </MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Secondary"
                               StartIcon="@Icons.Material.Filled.PlayArrow">
                        Study Mode
                    </MudButton>
                </div>
            </div>

            <!-- Study Mode Tabs -->
            <MudPaper Elevation="1" Class="mb-6" Style="border-radius: 12px;">
                <MudTabs Elevation="0" Color="Color.Primary" ApplyEffectsToContainer="true" PanelClass="pa-6">
                    <MudTabPanel Text="TERM">
                        <!-- Large Flashcard Display -->
                        <div class="d-flex justify-center align-center" Style="min-height: 400px;">
                            @if (_currentFlashcard != null)
                            {
                                <MudPaper Elevation="2" Class="pa-8 text-center cursor-pointer"
                                          Style="width: 600px; min-height: 350px; border-radius: 16px; display: flex; align-items: center; justify-content: center;"
                                          @onclick="FlipCard">
                                    <div>
                                        <MudText Typo="Typo.h3" Class="fw-bold mb-4">
                                            @(_isFlipped ? _currentFlashcard.BackText : _currentFlashcard.FrontText)
                                        </MudText>
                                        <MudText Typo="Typo.body1" Color="Color.Secondary">
                                            Click to flip
                                        </MudText>
                                    </div>
                                </MudPaper>
                            }
                            else
                            {
                                <MudText Typo="Typo.h6" Color="Color.Secondary">
                                    No flashcards in this set yet
                                </MudText>
                            }
                        </div>

                        <!-- Navigation Controls -->
                        @if (_currentFlashcard != null)
                        {
                            <div class="d-flex justify-center align-center gap-4 mt-6">
                                <MudIconButton Icon="@Icons.Material.Filled.ArrowBack"
                                               Color="Color.Primary"
                                               Size="Size.Large"
                                               Disabled="@(_currentCardIndex == 0)"
                                               OnClick="PreviousCard"/>

                                <MudText Typo="Typo.body1" Class="fw-semibold">
                                    @(_currentCardIndex + 1) / @state.Flashcards.Count
                                </MudText>

                                <MudIconButton Icon="@Icons.Material.Filled.ArrowForward"
                                               Color="Color.Primary"
                                               Size="Size.Large"
                                               Disabled="@(_currentCardIndex >= state.Flashcards.Count - 1)"
                                               OnClick="NextCard"/>
                            </div>

                            <div class="text-center mt-4">
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    <MudIcon Icon="@Icons.Material.Filled.FlipToFront" Size="Size.Small"/>
                                    Don't Recognize
                                </MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mx-8">|</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small"/>
                                    Recognize
                                </MudText>
                            </div>
                        }
                    </MudTabPanel>

                    <MudTabPanel Text="Flip" Icon="@Icons.Material.Filled.Flip">
                        <MudText Typo="Typo.body1" Color="Color.Secondary" Align="Align.Center" Class="py-8">
                            Flip mode content
                        </MudText>
                    </MudTabPanel>

                    <MudTabPanel Text="Learn" Icon="@Icons.Material.Filled.Psychology">
                        <MudText Typo="Typo.body1" Color="Color.Secondary" Align="Align.Center" Class="py-8">
                            Learn mode content
                        </MudText>
                    </MudTabPanel>

                    <MudTabPanel Text="Test" Icon="@Icons.Material.Filled.Quiz">
                        <MudText Typo="Typo.body1" Color="Color.Secondary" Align="Align.Center" Class="py-8">
                            Test mode content
                        </MudText>
                    </MudTabPanel>

                    <MudTabPanel Text="Match" Icon="@Icons.Material.Filled.Extension">
                        <MudText Typo="Typo.body1" Color="Color.Secondary" Align="Align.Center" Class="py-8">
                            Match mode content
                        </MudText>
                    </MudTabPanel>
                </MudTabs>
            </MudPaper>

            <!-- Terms List Section -->
            <div class="mb-6">
                <div class="d-flex justify-space-between align-center mb-3">
                    <MudText Typo="Typo.h6" Class="fw-bold">Terms in this set (@state.Flashcards.Count)</MudText>
                    <MudSelect T="string" Value="@("original")" Variant="Variant.Outlined" Dense="true"
                               Style="min-width: 150px;">
                        <MudSelectItem Value="@("original")">Original Order</MudSelectItem>
                        <MudSelectItem Value="@("alphabetical")">Alphabetical</MudSelectItem>
                    </MudSelect>
                </div>

                @if (state?.Flashcards?.Any() == true)
                {
                    @foreach (var flashcard in state.Flashcards)
                    {
                        <MudPaper Elevation="1" Class="pa-4 mb-3" Style="border-radius: 12px;">
                            <MudGrid>
                                <MudItem xs="12" md="5">
                                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-1">TERM</MudText>
                                    <MudText Typo="Typo.body1" Class="fw-semibold">@flashcard.FrontText</MudText>
                                </MudItem>
                                <MudItem xs="12" md="7">
                                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-1">DEFINITION</MudText>
                                    <MudText Typo="Typo.body1">@flashcard.BackText</MudText>
                                </MudItem>
                            </MudGrid>
                        </MudPaper>
                    }
                }
                else
                {
                    <MudText Typo="Typo.body1" Align="Align.Center" Color="Color.Secondary" Class="pa-8">
                        No terms in this set yet
                    </MudText>
                }
            </div>

            <!-- Study Mode Recommendation -->
            <MudPaper Elevation="1" Class="pa-6 text-center"
                      Style="border-radius: 12px; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);">
                <MudText Typo="Typo.h6" Class="fw-bold mb-2 text-white">Ready to master this set?</MudText>
                <MudText Typo="Typo.body2" Class="mb-4 text-white" Style="opacity: 0.9;">
                    Try our different study modes to test your knowledge
                </MudText>
                <div class="d-flex justify-center gap-3">
                    <MudButton Variant="Variant.Filled" Color="Color.Surface" Size="Size.Large">
                        Test
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" Style="border-color: white; color: white;" Size="Size.Large">
                        Match
                    </MudButton>
                </div>
            </MudPaper>
        }
    }
    else if (State.HasError)
    {
        <MudAlert Severity="Severity.Error">@(State.Error?.Message ?? "An error occurred")</MudAlert>
    }
    else
    {
        <div class="d-flex justify-center align-center min-h-400">
            <MudProgressCircular Indeterminate="true" Size="Size.Large"/>
        </div>
    }
</MudContainer>

@code {
    [Parameter] public Guid Id { get; set; }

    private string? _setTitle;
    private List<BreadcrumbItem> _breadcrumbs = new();
    private int _currentCardIndex;
    private bool _isFlipped;
    private FlashcardDto? _currentFlashcard;

    protected override async Task<FlashcardSetViewState> ComputeState(CancellationToken cancellationToken)
    {
        var set = await FlashcardSetService.GetFlashcardSetByIdAsync(Id, cancellationToken);
        var flashcards = (await FlashcardService.GetFlashcardsAsync(cancellationToken))
                .Where(f => f.StudySetId == Id)
                .ToImmutableList();

        if (set != null)
        {
            _setTitle = set.Title;
            UpdateBreadcrumbs(set);

            if (flashcards.Any() && _currentFlashcard == null)
            {
                _currentFlashcard = flashcards[0];
            }
        }

        return new FlashcardSetViewState
        {
                FlashcardSet = set,
                Flashcards = flashcards
        };
    }

    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();
        _currentCardIndex = 0;
        _isFlipped = false;
        _currentFlashcard = null;
    }

    private void UpdateBreadcrumbs(FlashcardSetDto set)
    {
        _breadcrumbs =
        [
                new BreadcrumbItem("Home", href: "/"),
                new BreadcrumbItem("Sciences", href: "/sciences"),
                new BreadcrumbItem("Astrophysics", href: "/astrophysics"),
                new BreadcrumbItem(set.Title, href: null, disabled: true)
        ];
    }

    private void FlipCard()
    {
        _isFlipped = !_isFlipped;
    }

    private void NextCard()
    {
        if (_currentCardIndex < State.Value.Flashcards.Count - 1)
        {
            _currentCardIndex++;
            _currentFlashcard = State.Value.Flashcards[_currentCardIndex];
            _isFlipped = false;
        }
    }

    private void PreviousCard()
    {
        if (_currentCardIndex > 0)
        {
            _currentCardIndex--;
            _currentFlashcard = State.Value.Flashcards[_currentCardIndex];
            _isFlipped = false;
        }
    }

    private void EditSet()
    {
        NavigationManager.NavigateTo($"/flashcard-sets/{Id}/edit");
    }

}

