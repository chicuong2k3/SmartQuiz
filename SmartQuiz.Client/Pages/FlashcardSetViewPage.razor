@page "/flashcard-sets/{Id:guid}"
@inherits ComputedStateComponent<FlashcardSetViewState>

@inject IFlashcardSetService FlashcardSetService
@inject IFlashcardService FlashcardService
@inject NavigationManager NavigationManager

<PageTitle>@(_setTitle ?? "Flashcard Set")</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="py-6">
    @if (State.HasValue && State.Value != null)
    {
        var state = State.Value;

        @if (state.FlashcardSet != null)
        {
            <!-- Header Section with Title and Action Buttons -->
            <div class="d-flex justify-space-between align-center mb-5 flex-wrap gap-3">
                <MudText Typo="Typo.h4" Class="fw-bold title-text">@state.FlashcardSet.Title</MudText>
                <div class="d-flex align-center gap-2">
                    <MudButton Variant="Variant.Filled" Class="header-btn"
                               StartIcon="@Icons.Material.Outlined.BookmarkBorder">
                        Lưu
                    </MudButton>
                    <MudButton Variant="Variant.Filled" Class="header-btn" StartIcon="@Icons.Material.Filled.Groups">
                        Nhóm
                    </MudButton>
                    <MudIconButton Icon="@Icons.Material.Outlined.IosShare" Class="header-icon-btn"/>
                    <MudIconButton Icon="@Icons.Material.Filled.MoreHoriz" Class="header-icon-btn"/>
                </div>
            </div>

            <!-- Study Mode Buttons Grid -->
            <div class="study-modes-grid mb-5">
                <MudButton Variant="Variant.Outlined" Class="study-mode-btn" StartIcon="@Icons.Material.Filled.Style">
                    Thẻ ghi nhớ
                </MudButton>
                <MudButton Variant="Variant.Outlined" Class="study-mode-btn"
                           StartIcon="@Icons.Material.Filled.AutoAwesome">
                    Học
                </MudButton>
                <MudButton Variant="Variant.Filled" Class="study-mode-btn study-mode-btn-active"
                           StartIcon="@Icons.Material.Filled.Quiz">
                    Kiểm tra
                </MudButton>
                <MudButton Variant="Variant.Outlined" Class="study-mode-btn"
                           StartIcon="@Icons.Material.Filled.GridView">
                    Khối hộp
                </MudButton>
                <MudButton Variant="Variant.Outlined" Class="study-mode-btn" StartIcon="@Icons.Material.Filled.Bolt">
                    Blast
                </MudButton>
                <MudButton Variant="Variant.Filled" Class="study-mode-btn study-mode-btn-active"
                           StartIcon="@Icons.Material.Filled.Extension">
                    Ghép thẻ
                </MudButton>
            </div>

            <!-- Flashcard Display Area -->
            <MudPaper Class="flashcard-container mb-4" Elevation="0">
                <!-- Top Bar -->
                <div class="d-flex justify-space-between align-center pa-4 flashcard-header">
                    <div class="d-flex align-center gap-2 hint-wrapper">
                        <MudIcon Icon="@Icons.Material.Outlined.Lightbulb" Size="Size.Small" Class="hint-icon"/>
                        <MudText Typo="Typo.body2" Class="hint-text">Hiển thị gợi ý</MudText>
                    </div>
                    <div class="d-flex align-center gap-1">
                        <MudIconButton Icon="@Icons.Material.Outlined.Edit" Size="Size.Small" Class="card-action-btn"
                                       OnClick="EditSet"/>
                        <MudIconButton Icon="@Icons.Material.Outlined.VolumeUp" Size="Size.Small"
                                       Class="card-action-btn"/>
                        <MudIconButton Icon="@Icons.Material.Outlined.StarBorder" Size="Size.Small"
                                       Class="card-action-btn"/>
                    </div>
                </div>

                <!-- Card Content -->
                <div class="flashcard-content" @onclick="FlipCard">
                    @if (_currentFlashcard != null)
                    {
                        <MudText Typo="Typo.h3" Class="flashcard-text">
                            @(_isFlipped ? _currentFlashcard.BackText : _currentFlashcard.FrontText)
                        </MudText>
                    }
                    else
                    {
                        <MudText Typo="Typo.h5" Class="flashcard-text empty-text">
                            Chưa có thẻ nào trong bộ này
                        </MudText>
                    }
                </div>
            </MudPaper>

            <!-- Bottom Controls -->
            <div class="d-flex justify-space-between align-center mb-6 flex-wrap gap-3 bottom-controls">
                <!-- Left: Progress Toggle -->
                <div class="d-flex align-center gap-2">
                    <MudText Typo="Typo.body2" Class="control-text">Theo dõi tiến độ</MudText>
                    <MudSwitch T="bool" @bind-Value="_trackProgress" Color="Color.Primary" Class="progress-switch"/>
                </div>

                <!-- Center: Navigation -->
                <div class="d-flex align-center gap-3 navigation-controls">
                    <MudIconButton Icon="@Icons.Material.Filled.ArrowBack"
                                   Class="nav-btn"
                                   Disabled="@(_currentCardIndex == 0 || state.Flashcards.Count == 0)"
                                   OnClick="PreviousCard"/>
                    <MudText Typo="Typo.body1" Class="card-counter">
                        @if (state.Flashcards.Count > 0)
                        {
                            <span>@(_currentCardIndex + 1) / @state.Flashcards.Count</span>
                        }
                        else
                        {
                            <span>0 / 0</span>
                        }
                    </MudText>
                    <MudIconButton Icon="@Icons.Material.Filled.ArrowForward"
                                   Class="nav-btn"
                                   Disabled="@(_currentCardIndex >= state.Flashcards.Count - 1 || state.Flashcards.Count == 0)"
                                   OnClick="NextCard"/>
                </div>

                <!-- Right: Playback Controls -->
                <div class="d-flex align-center gap-1 playback-controls">
                    <MudIconButton Icon="@Icons.Material.Filled.PlayArrow" Class="control-btn"/>
                    <MudIconButton Icon="@Icons.Material.Filled.Shuffle" Class="control-btn"/>
                    <MudIconButton Icon="@Icons.Material.Filled.Settings" Class="control-btn"/>
                    <MudIconButton Icon="@Icons.Material.Filled.Fullscreen" Class="control-btn"/>
                </div>
            </div>

            <!-- Creator Info -->
            <div class="d-flex align-center gap-3 mb-6">
                <MudAvatar Color="Color.Primary" Size="Size.Medium">
                    <MudIcon Icon="@Icons.Material.Filled.Person"/>
                </MudAvatar>
                <div>
                    <MudText Typo="Typo.caption" Class="creator-label">Tạo bởi</MudText>
                    <MudText Typo="Typo.body1" Class="fw-semibold">User</MudText>
                </div>
            </div>

            <!-- Terms List Section -->
            <div class="mb-6">
                <div class="d-flex justify-space-between align-center mb-4">
                    <MudText Typo="Typo.h6" Class="fw-bold">Thuật ngữ trong học phần này (@state.Flashcards.Count)
                    </MudText>
                    <div class="d-flex align-center gap-2">
                        <MudSelect T="string" Value="@_sortOrder" ValueChanged="@((string v) => _sortOrder = v)"
                                   Variant="Variant.Outlined" Dense="true" Class="sort-select">
                            <MudSelectItem Value="@("original")">Thứ tự gốc</MudSelectItem>
                            <MudSelectItem Value="@("alphabetical")">Theo bảng chữ cái</MudSelectItem>
                        </MudSelect>
                    </div>
                </div>

                @if (state?.Flashcards?.Any() == true)
                {
                    @foreach (var flashcard in state.Flashcards)
                    {
                        <MudPaper Elevation="0" Class="term-card mb-3">
                            <MudGrid>
                                <MudItem xs="12" md="5">
                                    <MudText Typo="Typo.body1" Class="fw-semibold">@flashcard.FrontText</MudText>
                                </MudItem>
                                <MudItem xs="12" md="7">
                                    <MudText Typo="Typo.body1">@flashcard.BackText</MudText>
                                </MudItem>
                            </MudGrid>
                        </MudPaper>
                    }
                }
                else
                {
                    <MudPaper Elevation="0" Class="term-card">
                        <MudText Typo="Typo.body1" Align="Align.Center" Class="pa-8" Style="opacity: 0.6;">
                            Chưa có thuật ngữ nào trong bộ này
                        </MudText>
                    </MudPaper>
                }
            </div>
        }
    }
    else if (State.HasError)
    {
        <MudAlert Severity="Severity.Error">@(State.Error?.Message ?? "Đã xảy ra lỗi")</MudAlert>
    }
    else
    {
        <div class="d-flex justify-center align-center" style="min-height: 400px;">
            <MudProgressCircular Indeterminate="true" Size="Size.Large" Color="Color.Primary"/>
        </div>
    }
</MudContainer>

@code {
    [Parameter] public Guid Id { get; set; }

    private string? _setTitle;
    private int _currentCardIndex;
    private bool _isFlipped;
    private bool _trackProgress;
    private string _sortOrder = "original";
    private FlashcardDto? _currentFlashcard;

    protected override async Task<FlashcardSetViewState> ComputeState(CancellationToken cancellationToken)
    {
        var set = await FlashcardSetService.GetFlashcardSetByIdAsync(Id, cancellationToken);
        var flashcards = (await FlashcardService.GetFlashcardsAsync(cancellationToken))
                .Where(f => f.StudySetId == Id)
                .ToImmutableList();

        if (set != null)
        {
            _setTitle = set.Title;

            if (flashcards.Any() && _currentFlashcard == null)
            {
                _currentFlashcard = flashcards[0];
            }
        }

        return new FlashcardSetViewState
        {
                FlashcardSet = set,
                Flashcards = flashcards
        };
    }

    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();
        _currentCardIndex = 0;
        _isFlipped = false;
        _currentFlashcard = null;
    }

    private void FlipCard()
    {
        _isFlipped = !_isFlipped;
    }

    private void NextCard()
    {
        if (_currentCardIndex < State.Value.Flashcards.Count - 1)
        {
            _currentCardIndex++;
            _currentFlashcard = State.Value.Flashcards[_currentCardIndex];
            _isFlipped = false;
        }
    }

    private void PreviousCard()
    {
        if (_currentCardIndex > 0)
        {
            _currentCardIndex--;
            _currentFlashcard = State.Value.Flashcards[_currentCardIndex];
            _isFlipped = false;
        }
    }

    private void EditSet()
    {
        NavigationManager.NavigateTo($"/flashcard-sets/{Id}/edit");
    }
}
