@page "/profile"
@inherits ComputedStateComponent<UserProfileState>

@inject IFlashcardSetService FlashcardSetService
@inject NavigationManager NavigationManager

<PageTitle>Alex Student - Profile</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="py-6">
    @if (State.HasValue && State.Value != null)
    {
        var state = State.Value;

        <MudGrid Spacing="4">
            <!-- Left Sidebar - Profile Card -->
            <MudItem xs="12" md="3">
                <MudPaper Elevation="1" Class="pa-4" Style="border-radius: 12px;">
                    <!-- Profile Overview Section with Active Indicator -->
                    <div class="d-flex align-center gap-3 pa-3 mb-2"
                         Style="background-color: #E3F2FD; border-radius: 8px;">
                        <MudIcon Icon="@Icons.Material.Filled.Person" Color="Color.Primary" Size="Size.Medium"/>
                        <MudText Typo="Typo.body1" Class="fw-semibold">Profile Overview</MudText>
                    </div>

                    <!-- Navigation Items -->
                    <div class="d-flex align-center gap-3 pa-3 mb-2 cursor-pointer">
                        <MudIcon Icon="@Icons.Material.Filled.LibraryBooks" Size="Size.Medium"/>
                        <MudText Typo="Typo.body1">Created Sets</MudText>
                    </div>

                    <div class="d-flex align-center gap-3 pa-3 mb-2 cursor-pointer">
                        <MudIcon Icon="@Icons.Material.Filled.Favorite" Size="Size.Medium"/>
                        <MudText Typo="Typo.body1">Favorite Sets</MudText>
                    </div>

                    <div class="d-flex align-center gap-3 pa-3 cursor-pointer">
                        <MudIcon Icon="@Icons.Material.Filled.Settings" Size="Size.Medium"/>
                        <MudText Typo="Typo.body1">Settings</MudText>
                    </div>
                </MudPaper>
            </MudItem>

            <!-- Main Content Area -->
            <MudItem xs="12" md="9">
                <!-- Profile Header with Avatar and Stats -->
                <MudPaper Elevation="1" Class="pa-6 mb-4"
                          Style="border-radius: 12px; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);">
                    <div class="d-flex align-center gap-4">
                        <MudAvatar Size="Size.Large" Style="width: 120px; height: 120px; background-color: white;">
                            <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Large"
                                     Style="font-size: 60px; color: #2196F3;"/>
                        </MudAvatar>

                        <div class="flex-grow-1">
                            <div class="d-flex align-center gap-3 mb-2">
                                <MudText Typo="Typo.h4" Class="fw-bold text-white">Alex Student</MudText>
                                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Surface"
                                               Size="Size.Small"/>
                            </div>
                            <MudText Typo="Typo.body1" Class="text-white mb-3">@("@")alex_quizzer</MudText>
                            <MudText Typo="Typo.body2" Class="text-white" Style="opacity: 0.9;">
                                Pre-med student loving biology and chemistry. Exploring the world of molecular science
                                one quiz at a time. ðŸ§¬ðŸ§ª
                            </MudText>
                        </div>
                    </div>

                    <!-- Stats Row -->
                    <MudGrid Spacing="3" Class="mt-4">
                        <MudItem xs="4">
                            <MudPaper Elevation="0" Class="pa-3 text-center"
                                      Style="background-color: rgba(255,255,255,0.2); border-radius: 8px;">
                                <MudIcon Icon="@Icons.Material.Filled.LocalFireDepartment" Color="Color.Surface"
                                         Class="mb-1"/>
                                <MudText Typo="Typo.h6" Class="fw-bold text-white">12</MudText>
                                <MudText Typo="Typo.caption" Class="text-white">Days active</MudText>
                            </MudPaper>
                        </MudItem>
                        <MudItem xs="4">
                            <MudPaper Elevation="0" Class="pa-3 text-center"
                                      Style="background-color: rgba(255,255,255,0.2); border-radius: 8px;">
                                <MudIcon Icon="@Icons.Material.Filled.Collections" Color="Color.Surface" Class="mb-1"/>
                                <MudText Typo="Typo.h6" Class="fw-bold text-white">15</MudText>
                                <MudText Typo="Typo.caption" Class="text-white">Study sets</MudText>
                            </MudPaper>
                        </MudItem>
                        <MudItem xs="4">
                            <MudPaper Elevation="0" Class="pa-3 text-center"
                                      Style="background-color: rgba(255,255,255,0.2); border-radius: 8px;">
                                <MudIcon Icon="@Icons.Material.Filled.Wysiwyg" Color="Color.Surface" Class="mb-1"/>
                                <MudText Typo="Typo.h6" Class="fw-bold text-white">8.5k</MudText>
                                <MudText Typo="Typo.caption" Class="text-white">Experience</MudText>
                            </MudPaper>
                        </MudItem>
                    </MudGrid>
                </MudPaper>

                <!-- Meta Information -->
                <MudPaper Elevation="1" Class="pa-4 mb-4" Style="border-radius: 12px;">
                    <MudGrid Spacing="3">
                        <MudItem xs="12" md="4">
                            <div class="d-flex align-center gap-2">
                                <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small"
                                         Color="Color.Secondary"/>
                                <MudText Typo="Typo.body2">Joined March 2023</MudText>
                            </div>
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <div class="d-flex align-center gap-2">
                                <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small"
                                         Color="Color.Secondary"/>
                                <MudText Typo="Typo.body2">San Francisco, CA</MudText>
                            </div>
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <div class="d-flex align-center gap-2">
                                <MudIcon Icon="@Icons.Material.Filled.School" Size="Size.Small"
                                         Color="Color.Secondary"/>
                                <MudText Typo="Typo.body2">University of Science</MudText>
                            </div>
                        </MudItem>
                    </MudGrid>
                </MudPaper>

                <!-- Tabs Section -->
                <MudTabs Elevation="0" ApplyEffectsToContainer="true" PanelClass="pa-4"
                         Style="border-radius: 12px; background-color: white;">
                    <MudTabPanel Text="CREATED SETS" Icon="@Icons.Material.Filled.Add">
                        <div class="mb-3">
                            <div class="d-flex justify-space-between align-center">
                                <MudText Typo="Typo.h6" Class="fw-bold">Recent Sets</MudText>
                                <div class="d-flex gap-2">
                                    <MudSelect T="string" Value="@("recent")" Variant="Variant.Outlined" Dense="true"
                                               Style="min-width: 150px;">
                                        <MudSelectItem Value="@("recent")">Most Recent</MudSelectItem>
                                        <MudSelectItem Value="@("oldest")">Oldest</MudSelectItem>
                                        <MudSelectItem Value="@("az")">A-Z</MudSelectItem>
                                    </MudSelect>
                                    <MudButton Variant="Variant.Filled" Color="Color.Secondary"
                                               StartIcon="@Icons.Material.Filled.Add">
                                        CREATE SET
                                    </MudButton>
                                </div>
                            </div>
                        </div>

                        @if (state?.UserSets?.Any() == true)
                        {
                            <MudGrid Spacing="3">
                                @foreach (var set in state.UserSets)
                                {
                                    <MudItem xs="12" md="6">
                                        <MudCard Elevation="1" Class="cursor-pointer" Style="border-radius: 12px;"
                                                 @onclick="@(() => ViewSet(set.Id))">
                                            <!-- Card Image with Term Count Badge -->
                                            <div class="position-relative"
                                                 Style="height: 180px; background: @GetSetBackground(set);">
                                                <div class="position-absolute bottom-3 right-3">
                                                    <MudChip T="string" Color="Color.Dark" Size="Size.Small"
                                                             Style="background-color: rgba(0,0,0,0.7); color: white;">
                                                        @set.FlashcardCount Terms
                                                    </MudChip>
                                                </div>
                                            </div>

                                            <MudCardContent Class="pa-3">
                                                <div class="d-flex justify-space-between align-center mb-2">
                                                    <MudText Typo="Typo.h6"
                                                             Class="fw-bold text-truncate">@set.Title</MudText>
                                                    <MudIconButton Icon="@Icons.Material.Filled.Star"
                                                                   Color="Color.Default" Size="Size.Small"/>
                                                </div>

                                                <div class="d-flex align-center gap-2">
                                                    <MudAvatar Size="Size.Small" Class="avatar-xs">
                                                        <MudIcon Icon="@Icons.Material.Filled.Person"
                                                                 Size="Size.Small"/>
                                                    </MudAvatar>
                                                    <MudText Typo="Typo.body2" Color="Color.Secondary">Created by You
                                                    </MudText>
                                                </div>
                                            </MudCardContent>
                                        </MudCard>
                                    </MudItem>
                                }
                            </MudGrid>

                            <div class="text-center mt-4">
                                <MudLink Typo="Typo.body2" Color="Color.Primary" Class="fw-semibold">VIEW ALL SETS â†’
                                </MudLink>
                            </div>
                        }
                        else
                        {
                            <MudText Typo="Typo.body1" Align="Align.Center" Color="Color.Secondary" Class="pa-8">
                                You haven't created any study sets yet.
                            </MudText>
                        }
                    </MudTabPanel>

                    <MudTabPanel Text="FAVORITES" Icon="@Icons.Material.Filled.Favorite">
                        <MudText Typo="Typo.body1" Align="Align.Center" Color="Color.Secondary" Class="pa-8">
                            No favorite sets yet.
                        </MudText>
                    </MudTabPanel>

                    <MudTabPanel Text="ACTIVITY" Icon="@Icons.Material.Filled.History">
                        <MudText Typo="Typo.body1" Align="Align.Center" Color="Color.Secondary" Class="pa-8">
                            No recent activity.
                        </MudText>
                    </MudTabPanel>
                </MudTabs>
            </MudItem>
        </MudGrid>
    }
    else if (State.HasError)
    {
        <MudAlert Severity="Severity.Error">@(State.Error?.Message ?? "An error occurred")</MudAlert>
    }
    else
    {
        <div class="d-flex justify-center align-center min-h-400">
            <MudProgressCircular Indeterminate="true" Size="Size.Large"/>
        </div>
    }
</MudContainer>

@code {

    protected override async Task<UserProfileState> ComputeState(CancellationToken cancellationToken)
    {
        try
        {
            var setsResult = await FlashcardSetService.GetFlashcardSetsAsync(cancellationToken);
            var sets = setsResult?.ToImmutableList() ?? ImmutableList<FlashcardSetDto>.Empty;

            return new UserProfileState
            {
                UserSets = sets
            };
        }
        catch (Exception)
        {
            return new UserProfileState
            {
                UserSets = ImmutableList<FlashcardSetDto>.Empty
            };
        }
    }


    private string GetSetBackground(FlashcardSetDto set)
    {
        var backgrounds = new[]
        {
            "linear-gradient(135deg, #134e5e 0%, #71b280 100%)",
            "linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%)",
            "linear-gradient(135deg, #f2994a 0%, #f2c94c 100%)",
            "linear-gradient(135deg, #ee9ca7 0%, #ffdde1 100%)",
            "linear-gradient(135deg, #2c3e50 0%, #3498db 100%)",
            "linear-gradient(135deg, #bdc3c7 0%, #2c3e50 100%)"
        };

        return backgrounds[Math.Abs(set.Id.GetHashCode()) % backgrounds.Length];
    }

    private void ViewSet(Guid setId)
    {
        NavigationManager.NavigateTo($"/flashcard-sets/{setId}");
    }

}

